const data = {
    'bpLadders': {
        '50': [
            1350,
            916,
            766,
            700,
            650,
            600,
            550,
            500,
            450,
            400,
            350,
            300,
            250,
            200,
            150,
            100,
            50
        ],
        '100': [
            1517,
            1200,
            1000,
            900,
            800,
            700,
            600,
            517,
            500,
            400,
            300,
            200,
            100
        ]
    },
    'enzymes': {
        'AatI': {
            'cutindex': 3,
            'cutsite': 'AGGCCT'
        },
        'AatII': {
            'cutindex': 5,
            'cutsite': 'GACGTC'
        },
        'Acc65I': {
            'cutindex': 1,
            'cutsite': 'GGTACC'
        },
        'AccI': {
            'cutindex': 2,
            'cutsite': 'GTMKAC'
        },
        'AccIII': {
            'cutindex': 1,
            'cutsite': 'TCCGGA'
        },
        'AcsI': {
            'cutindex': 1,
            'cutsite': 'RAATTY'
        },
        'AcyI': {
            'cutindex': 2,
            'cutsite': 'GRCGYC'
        },
        'AflI': {
            'cutindex': 1,
            'cutsite': 'GGWCC'
        },
        'AflII': {
            'cutindex': 1,
            'cutsite': 'CTTAAG'
        },
        'AflIII': {
            'cutindex': 1,
            'cutsite': 'ACRYGT'
        },
        'AgeI': {
            'cutindex': 1,
            'cutsite': 'ACCGGT'
        },
        'AhaII': {
            'cutindex': 2,
            'cutsite': 'GRCGYC'
        },
        'AhaIII': {
            'cutindex': 3,
            'cutsite': 'TTTAAA'
        },
        'AluI': {
            'cutindex': 2,
            'cutsite': 'AGCT'
        },
        'Alw44I': {
            'cutindex': 1,
            'cutsite': 'GTGCAC'
        },
        'AlwNI': {
            'cutindex': 6,
            'cutsite': 'CAGNNNCTG'
        },
        'AocI': {
            'cutindex': 2,
            'cutsite': 'CCTNAGG'
        },
        'AosI': {
            'cutindex': 3,
            'cutsite': 'TGCGCA'
        },
        'ApaI': {
            'cutindex': 5,
            'cutsite': 'GGGCCC'
        },
        'ApaLI': {
            'cutindex': 1,
            'cutsite': 'GTGCAC'
        },
        'ApoI': {
            'cutindex': 1,
            'cutsite': 'RAATTY'
        },
        'AscI': {
            'cutindex': 2,
            'cutsite': 'GGCGCGCC'
        },
        'AseI': {
            'cutindex': 2,
            'cutsite': 'ATTAAT'
        },
        'AsnI': {
            'cutindex': 2,
            'cutsite': 'ATTAAT'
        },
        'Asp700': {
            'cutindex': 5,
            'cutsite': 'GAANNNNTTC'
        },
        'Asp718': {
            'cutindex': 1,
            'cutsite': 'GGTACC'
        },
        'AspEI': {
            'cutindex': 6,
            'cutsite': 'GACNNNNNGTC'
        },
        'AspHI': {
            'cutindex': 5,
            'cutsite': 'GWGCWC'
        },
        'AspI': {
            'cutindex': 4,
            'cutsite': 'GACNNNGTC'
        },
        'AsuII': {
            'cutindex': 2,
            'cutsite': 'TTCGAA'
        },
        'AvaI': {
            'cutindex': 1,
            'cutsite': 'CYCGRG'
        },
        'AvaII': {
            'cutindex': 1,
            'cutsite': 'GGWCC'
        },
        'AviII': {
            'cutindex': 3,
            'cutsite': 'TGCGCA'
        },
        'AvrII': {
            'cutindex': 1,
            'cutsite': 'CCTAGG'
        },
        'BalI': {
            'cutindex': 3,
            'cutsite': 'TGGCCA'
        },
        'BamHI': {
            'cutindex': 1,
            'cutsite': 'GGATCC'
        },
        'BanI': {
            'cutindex': 1,
            'cutsite': 'GGYRCC'
        },
        'BanII': {
            'cutindex': 5,
            'cutsite': 'GRGCYC'
        },
        'BbrPI': {
            'cutindex': 3,
            'cutsite': 'CACGTG'
        },
        'BclI': {
            'cutindex': 1,
            'cutsite': 'TGATCA'
        },
        'BfaI': {
            'cutindex': 1,
            'cutsite': 'CTAG'
        },
        'BfrI': {
            'cutindex': 1,
            'cutsite': 'CTTAAG'
        },
        'BglI': {
            'cutindex': 7,
            'cutsite': 'GCCNNNNNGGC'
        },
        'BglII': {
            'cutindex': 1,
            'cutsite': 'AGATCT'
        },
        'BinI': {
            'cutindex': 1,
            'cutsite': 'CCTAGG'
        },
        'BmyI': {
            'cutindex': 5,
            'cutsite': 'GDGCHC'
        },
        'Bpu1102I': {
            'cutindex': 2,
            'cutsite': 'GCTNAGC'
        },
        'BsaAI': {
            'cutindex': 3,
            'cutsite': 'YACGTR'
        },
        'BsaBI': {
            'cutindex': 5,
            'cutsite': 'GATNNNNATC'
        },
        'BsaHI': {
            'cutindex': 2,
            'cutsite': 'GRCGYC'
        },
        'BsaJI': {
            'cutindex': 1,
            'cutsite': 'CCNNGG'
        },
        'BseAI': {
            'cutindex': 1,
            'cutsite': 'TCCGGA'
        },
        'BsePI': {
            'cutindex': 1,
            'cutsite': 'GCGCGC'
        },
        'BsiEI': {
            'cutindex': 4,
            'cutsite': 'CGRYCG'
        },
        'BsiWI': {
            'cutindex': 1,
            'cutsite': 'CGTACG'
        },
        'BsiYI': {
            'cutindex': 7,
            'cutsite': 'CCNNNNNNNGG'
        },
        'BslI': {
            'cutindex': 7,
            'cutsite': 'CCNNNNNNNGG'
        },
        'Bsp1286I': {
            'cutindex': 5,
            'cutsite': 'GDGCHC'
        },
        'Bsp1407I': {
            'cutindex': 1,
            'cutsite': 'TGTACA'
        },
        'BspDI': {
            'cutindex': 2,
            'cutsite': 'ATCGAT'
        },
        'BspEI': {
            'cutindex': 1,
            'cutsite': 'TCCGGA'
        },
        'BspHI': {
            'cutindex': 1,
            'cutsite': 'TCATGA'
        },
        'BspLU11I': {
            'cutindex': 1,
            'cutsite': 'ACATGT'
        },
        'BsrFI': {
            'cutindex': 1,
            'cutsite': 'RCCGGY'
        },
        'BssGI': {
            'cutindex': 8,
            'cutsite': 'CCANNNNNNTGG'
        },
        'BssHII': {
            'cutindex': 1,
            'cutsite': 'GCGCGC'
        },
        'Bst1107I': {
            'cutindex': 3,
            'cutsite': 'GTATAC'
        },
        'BstBI': {
            'cutindex': 2,
            'cutsite': 'TTCGAA'
        },
        'BstEII': {
            'cutindex': 1,
            'cutsite': 'GGTNACC'
        },
        'BstNI': {
            'cutindex': 2,
            'cutsite': 'CCWGG'
        },
        'BstUI': {
            'cutindex': 2,
            'cutsite': 'CGCG'
        },
        'BstXI': {
            'cutindex': 8,
            'cutsite': 'CCANNNNNNTGG'
        },
        'BstYI': {
            'cutindex': 1,
            'cutsite': 'RGATCY'
        },
        'Bsu36I': {
            'cutindex': 2,
            'cutsite': 'CCTNAGG'
        },
        'CelII': {
            'cutindex': 2,
            'cutsite': 'GCTNAGC'
        },
        'CfoI': {
            'cutindex': 3,
            'cutsite': 'GCGC'
        },
        'Cfr10I': {
            'cutindex': 1,
            'cutsite': 'RCCGGY'
        },
        'CfrI': {
            'cutindex': 1,
            'cutsite': 'YGGCCR'
        },
        'ClaI': {
            'cutindex': 2,
            'cutsite': 'ATCGAT'
        },
        'DdeI': {
            'cutindex': 1,
            'cutsite': 'CTNAG'
        },
        'DraI': {
            'cutindex': 3,
            'cutsite': 'TTTAAA'
        },
        'DraII': {
            'cutindex': 2,
            'cutsite': 'RGGNCCY'
        },
        'DraIII': {
            'cutindex': 6,
            'cutsite': 'CACNNNGTG'
        },
        'DrdI': {
            'cutindex': 7,
            'cutsite': 'GACNNNNNNGTC'
        },
        'DsaI': {
            'cutindex': 1,
            'cutsite': 'CCRYGG'
        },
        'EaeI': {
            'cutindex': 1,
            'cutsite': 'YGGCCR'
        },
        'EagI': {
            'cutindex': 1,
            'cutsite': 'CGGCCG'
        },
        'Eam1105I': {
            'cutindex': 6,
            'cutsite': 'GACNNNNNGTC'
        },
        'Ecl136II': {
            'cutindex': 3,
            'cutsite': 'GAGCTC'
        },
        'EclXI': {
            'cutindex': 1,
            'cutsite': 'CGGCCG'
        },
        'Eco47III': {
            'cutindex': 3,
            'cutsite': 'AGCGCT'
        },
        'EcoNI': {
            'cutindex': 5,
            'cutsite': 'CCTNNNNNAGG'
        },
        'EcoO109I': {
            'cutindex': 2,
            'cutsite': 'RGGNCCY'
        },
        'EcoRI': {
            'cutindex': 1,
            'cutsite': 'GAATTC'
        },
        'EcoRV': {
            'cutindex': 3,
            'cutsite': 'GATATC'
        },
        'EspI': {
            'cutindex': 2,
            'cutsite': 'GCTNAGC'
        },
        'Fnu4HI': {
            'cutindex': 2,
            'cutsite': 'GCNGC'
        },
        'FnuDII': {
            'cutindex': 2,
            'cutsite': 'CGCG'
        },
        'FseI': {
            'cutindex': 6,
            'cutsite': 'GGCCGGCC'
        },
        'FspI': {
            'cutindex': 3,
            'cutsite': 'TGCGCA'
        },
        'HaeII': {
            'cutindex': 5,
            'cutsite': 'RGCGCY'
        },
        'HaeIII': {
            'cutindex': 2,
            'cutsite': 'GGCC'
        },
        'HgiAI': {
            'cutindex': 5,
            'cutsite': 'GWGCWC'
        },
        'HhaI': {
            'cutindex': 3,
            'cutsite': 'GCGC'
        },
        'HinPI': {
            'cutindex': 1,
            'cutsite': 'GCGC'
        },
        'HincII': {
            'cutindex': 3,
            'cutsite': 'GTYRAC'
        },
        'HindII': {
            'cutindex': 3,
            'cutsite': 'GTYRAC'
        },
        'HindIII': {
            'cutindex': 1,
            'cutsite': 'AAGCTT'
        },
        'HinfI': {
            'cutindex': 1,
            'cutsite': 'GANTC'
        },
        'HpaI': {
            'cutindex': 3,
            'cutsite': 'GTTAAC'
        },
        'HpaII': {
            'cutindex': 1,
            'cutsite': 'CCGG'
        },
        'ItaI': {
            'cutindex': 2,
            'cutsite': 'GCNGC'
        },
        'KasI': {
            'cutindex': 1,
            'cutsite': 'GGCGCC'
        },
        'KpnI': {
            'cutindex': 5,
            'cutsite': 'GGTACC'
        },
        'KspI': {
            'cutindex': 4,
            'cutsite': 'CCGCGG'
        },
        'MaeI': {
            'cutindex': 1,
            'cutsite': 'CTAG'
        },
        'MaeII': {
            'cutindex': 1,
            'cutsite': 'ACGT'
        },
        'MamI': {
            'cutindex': 5,
            'cutsite': 'GATNNNNATC'
        },
        'MfeI': {
            'cutindex': 1,
            'cutsite': 'CAATTG'
        },
        'MluI': {
            'cutindex': 1,
            'cutsite': 'ACGCGT'
        },
        'MluNI': {
            'cutindex': 3,
            'cutsite': 'TGGCCA'
        },
        'MroI': {
            'cutindex': 1,
            'cutsite': 'TCCGGA'
        },
        'MscI': {
            'cutindex': 3,
            'cutsite': 'TGGCCA'
        },
        'MseI': {
            'cutindex': 1,
            'cutsite': 'TTAA'
        },
        'MspI': {
            'cutindex': 1,
            'cutsite': 'CCGG'
        },
        'MstI': {
            'cutindex': 3,
            'cutsite': 'TGCGCA'
        },
        'MstII': {
            'cutindex': 2,
            'cutsite': 'CCTNAGG'
        },
        'MunI': {
            'cutindex': 1,
            'cutsite': 'CAATTG'
        },
        'MvaI': {
            'cutindex': 2,
            'cutsite': 'CCWGG'
        },
        'MvnI': {
            'cutindex': 2,
            'cutsite': 'CGCG'
        },
        'NaeI': {
            'cutindex': 3,
            'cutsite': 'GCCGGC'
        },
        'NarI': {
            'cutindex': 2,
            'cutsite': 'GGCGCC'
        },
        'NciI': {
            'cutindex': 2,
            'cutsite': 'CCSGG'
        },
        'NcoI': {
            'cutindex': 1,
            'cutsite': 'CCATGG'
        },
        'NdeI': {
            'cutindex': 2,
            'cutsite': 'CATATG'
        },
        'NgoMI': {
            'cutindex': 1,
            'cutsite': 'GCCGGC'
        },
        'NheI': {
            'cutindex': 1,
            'cutsite': 'GCTAGC'
        },
        'NlaIII': {
            'cutindex': 4,
            'cutsite': 'CATG'
        },
        'NlaIV': {
            'cutindex': 3,
            'cutsite': 'GGNNCC'
        },
        'NotI': {
            'cutindex': 2,
            'cutsite': 'GCGGCCGC'
        },
        'NruI': {
            'cutindex': 3,
            'cutsite': 'TCGCGA'
        },
        'NsiI': {
            'cutindex': 5,
            'cutsite': 'ATGCAT'
        },
        'NspBII': {
            'cutindex': 3,
            'cutsite': 'CMGCKG'
        },
        'NspI': {
            'cutindex': 5,
            'cutsite': 'RCATGY'
        },
        'NspII': {
            'cutindex': 5,
            'cutsite': 'GDGCHC'
        },
        'NspV': {
            'cutindex': 2,
            'cutsite': 'TTCGAA'
        },
        'PacI': {
            'cutindex': 5,
            'cutsite': 'TTAATTAA'
        },
        'PaeR7I': {
            'cutindex': 1,
            'cutsite': 'CTCGAG'
        },
        'PflMI': {
            'cutindex': 7,
            'cutsite': 'CCANNNNNTGG'
        },
        'PinAI': {
            'cutindex': 1,
            'cutsite': 'ACCGGT'
        },
        'PmaCI': {
            'cutindex': 3,
            'cutsite': 'CACGTG'
        },
        'PmeI': {
            'cutindex': 4,
            'cutsite': 'GTTTAAAC'
        },
        'PmlI': {
            'cutindex': 3,
            'cutsite': 'CACGTG'
        },
        'PpuMI': {
            'cutindex': 2,
            'cutsite': 'RGGWCCY'
        },
        'Psp1406I': {
            'cutindex': 2,
            'cutsite': 'AACGTT'
        },
        'PstI': {
            'cutindex': 5,
            'cutsite': 'CTGCAG'
        },
        'PvuI': {
            'cutindex': 4,
            'cutsite': 'CGATCG'
        },
        'PvuII': {
            'cutindex': 3,
            'cutsite': 'CAGCTG'
        },
        'RcaI': {
            'cutindex': 1,
            'cutsite': 'TCATGA'
        },
        'RmaI': {
            'cutindex': 1,
            'cutsite': 'CTAG'
        },
        'RsaI': {
            'cutindex': 2,
            'cutsite': 'GTAC'
        },
        'RsrII': {
            'cutindex': 2,
            'cutsite': 'CGGWCCG'
        },
        'SacI': {
            'cutindex': 5,
            'cutsite': 'GAGCTC'
        },
        'SacII': {
            'cutindex': 4,
            'cutsite': 'CCGCGG'
        },
        'SalI': {
            'cutindex': 1,
            'cutsite': 'GTCGAC'
        },
        'Sau96I': {
            'cutindex': 1,
            'cutsite': 'GGNCC'
        },
        'SauI': {
            'cutindex': 2,
            'cutsite': 'CCTNAGG'
        },
        'ScaI': {
            'cutindex': 3,
            'cutsite': 'AGTACT'
        },
        'ScrFI': {
            'cutindex': 2,
            'cutsite': 'CCNGG'
        },
        'SexAI': {
            'cutindex': 1,
            'cutsite': 'ACCWGGT'
        },
        'SfcI': {
            'cutindex': 1,
            'cutsite': 'CTRYAG'
        },
        'SfiI': {
            'cutindex': 8,
            'cutsite': 'GGCCNNNNNGGCC'
        },
        'SfuI': {
            'cutindex': 2,
            'cutsite': 'TTCGAA'
        },
        'SgrAI': {
            'cutindex': 2,
            'cutsite': 'CRCCGGYG'
        },
        'SmaI': {
            'cutindex': 3,
            'cutsite': 'CCCGGG'
        },
        'SnaBI': {
            'cutindex': 3,
            'cutsite': 'TACGTA'
        },
        'SnoI': {
            'cutindex': 1,
            'cutsite': 'GTGCAC'
        },
        'SpeI': {
            'cutindex': 1,
            'cutsite': 'ACTAGT'
        },
        'SphI': {
            'cutindex': 5,
            'cutsite': 'GCATGC'
        },
        'SrfI': {
            'cutindex': 4,
            'cutsite': 'GCCCGGGC'
        },
        'Sse8387I': {
            'cutindex': 6,
            'cutsite': 'CCTGCAGG'
        },
        'SspBI': {
            'cutindex': 1,
            'cutsite': 'TGTACA'
        },
        'SspI': {
            'cutindex': 3,
            'cutsite': 'AATATT'
        },
        'SstI': {
            'cutindex': 5,
            'cutsite': 'GAGCTC'
        },
        'SstII': {
            'cutindex': 4,
            'cutsite': 'CCGCGG'
        },
        'StuI': {
            'cutindex': 3,
            'cutsite': 'AGGCCT'
        },
        'StyI': {
            'cutindex': 1,
            'cutsite': 'CCWWGG'
        },
        'SwaI': {
            'cutindex': 4,
            'cutsite': 'ATTTAAAT'
        },
        'TaqI': {
            'cutindex': 1,
            'cutsite': 'TCGA'
        },
        'TfiI': {
            'cutindex': 1,
            'cutsite': 'GAWTC'
        },
        'ThaI': {
            'cutindex': 2,
            'cutsite': 'CGCG'
        },
        'Tru9I': {
            'cutindex': 1,
            'cutsite': 'TTAA'
        },
        'Tth111I': {
            'cutindex': 4,
            'cutsite': 'GACNNNGTC'
        },
        'Van91I': {
            'cutindex': 7,
            'cutsite': 'CCANNNNNTGG'
        },
        'XbaI': {
            'cutindex': 1,
            'cutsite': 'TCTAGA'
        },
        'XcmI': {
            'cutindex': 8,
            'cutsite': 'CCANNNNNNNNNTGG'
        },
        'XhoI': {
            'cutindex': 1,
            'cutsite': 'CTCGAG'
        },
        'XhoII': {
            'cutindex': 1,
            'cutsite': 'RGATCY'
        },
        'XmaCI': {
            'cutindex': 1,
            'cutsite': 'CCCGGG'
        },
        'XmaI': {
            'cutindex': 1,
            'cutsite': 'CCCGGG'
        },
        'XmaIII': {
            'cutindex': 1,
            'cutsite': 'CGGCCG'
        },
        'XmnI': {
            'cutindex': 5,
            'cutsite': 'GAANNNNTTC'
        }
    }
};
const {enzymes, bpLadders} = data;

const PRIMERS = ['b1', 'b2', 'f1', 'f2', 'linker'];


/**
 * @typedef {object} LampReaction
 *
 * @property {string} b1 the b1 primer sequence
 * @property {string} b2 the b2 primer sequence
 * @property {string} f1 the f1 primer sequence
 * @property {string} f2 the f2 primer sequence
 * @property {string} linker the linker sequence
 * @property {string} target the target sequence
 * @property {string} targetName the name of the target sequence
 */

/**
 * @typedef {object} PrimerPositions
 *
 * @property {object} b1 the b1 primer position
 * @property {object} b2 the b2 primer position
 * @property {object} f1 the f1 primer position
 * @property {object} f2 the f2 primer position
 */

/**
 * @typedef {object} LampBuildingBlocks
 *
 * @property {string} bplus
 * @property {string} bminus
 * @property {string} fplus
 * @property {string} fminus
 * @property {string} plus
 * @property {string} minus
 */

/**
 *
 * @param {string} fasta  the input fasta content
 *
 * @returns {LampReaction} the parsed reaction parameters
 */
const parseLampFasta = (fasta) => {

    const sequences = {linker: 'tttt'};

    const lines = fasta.split(/\n/g);
    let state = '';

    for (const rawLine of lines) {
        const line = rawLine.trim();

        if (!line) {
            continue;
        }

        if (!state) {
            if (!line.startsWith('>')) {
                throw new Error(`expected a new sequence name marker '>' but found ${line}`);
            }
            state = line.replace('>', '').trim();
            sequences[state] = '';
        } else {
            if (line.startsWith('>')) {
                if (!sequences[state]) {
                    throw new Error(`expected sequence content for marker ${state} but found ${line}`);
                } else {
                    state = line.replace('>', '').trim();
                    sequences[state] = '';
                }
            } else {
                sequences[state] += line;
            }
        }
    }
    const reaction = {};

    for (const primer of PRIMERS) {
        if (!sequences[primer]) {
            throw new Error(`Missing sequence for ${primer} primer`);
        }
        reaction[primer] = sequences[primer].toLowerCase();
    }

    const targets = Object.keys(sequences).filter(seq => !PRIMERS.includes(seq));

    if (!targets.length) {
        throw new Error('only primers detected, missing target sequence');
    } else if (targets.length !== 1) {
        throw new Error(`too many targets detected (${targets.join(', ')}). Only 1 target sequence is supported`);
    }


    [reaction.targetName] = targets;
    reaction.target = sequences[reaction.targetName].toLowerCase();
    return reaction;
};

const complementSeq = (seq, reverse = false) => {
    if (seq == null) {
        return null;
    }
    seq = seq.toLowerCase();
    var result = [];

    for (var k = 0; k < seq.length; k++){
        var i = k;

        if (reverse){
            i = seq.length - k - 1;
        }

        switch (seq.charAt(i)){
            case 'c':
                result.push('g');
                break;
            case 'g':
                result.push('c');
                break;
            case 't':
                result.push('a');
                break;
            case 'a':
                result.push('t');
                break;
            case 'r': //a, g --> t, c
                result.push('y');
                break;
            case 'y': //c, t --> g, a
                result.push('r');
                break;
            case 'k': //g, t --> c, a
                result.push('m');
                break;
            case 'm': //a, c --> t, g
                result.push('k');
                break;
            case 'b': //c, g, t --> g, c, a
                result.push('v');
                break;
            case 'd': //a, g, t --> t, c, a
                result.push('h');
                break;
            case 'h': //a, c, t --> t, g, a
                result.push('d');
                break;
            case 'v': //a, c, g --> t, g, c
                result.push('b');
                break;
            default: //s, w, n
                result.push(seq.charAt(i));
                break;
        }
    }
    return result.join('');
};

/**
 * find the best alignment position for an primer on a target
 *
 * @param {string} targetSeq the target string
 * @param {string} primerSeq the primer string (primerSeq.length<str.length)
 *
 * @returns returns a match object with the index position and whether or not the best match was found with the original primer string or the reverse complement
 */
const alignPrimer = (targetSeq, primerSeq) => {
    var revcomp = complementSeq(primerSeq, true);
    var minscore = primerSeq.length; //min number of differences btwn primer and sequence
    var reverse = false; //min number of differences btwn revcomp and sequence
    var index = 0;

    for (var i = 0; i < targetSeq.length - primerSeq.length; i++){
        let score = 0,
            revscore = 0;

        for (var j = 0; j < primerSeq.length; j++){
            if (targetSeq.charAt(i + j) != primerSeq.charAt(j)){
                score += 1;
            }
            if (targetSeq.charAt(i + j) != revcomp.charAt(j)){
                revscore += 1;
            }
            if (score > minscore && revscore > minscore){
                break;
            }
        }

        if (score <= revscore && score < minscore){
            minscore = score; reverse = false; index = i;
        } else if (revscore < score && revscore < minscore){
            minscore = revscore; reverse = true; index = i;
        }
    }
    return {index: index, reverse: reverse};
};

/**
 * Check that the layout of the primers is valid and the reaction can proceed. Fix common mistakes
 * where it is possible to guess the correct input
 *
 * @param {LampReaction} reaction the parse lamp reaction paramters
 *
 * @returns {Array[LampReaction, PrimerPositions]} the modified lamp reaction and the primer matches
 */
const getPrimerLayout = (inputReaction) => {
    const rxn = Object.assign({}, inputReaction);
    var b2match = alignPrimer(rxn.target, rxn.b2);
    var f2match = alignPrimer(rxn.target, rxn.f2);

    if (b2match.index < f2match.index){
        if (b2match.reverse == true){
            console.warn('input string was the other strand from what was needed. will take the compliment and re-compute');
            rxn.target = complementSeq(rxn.target, false); //just gives the compliment, not reversed
            b2match = alignPrimer(rxn.target, rxn.b2);
            f2match = alignPrimer(rxn.target, rxn.f2);
        }
    } else {
        if (b2match.reverse == true){
            console.warn('need reverse compliment of the input strand. generating...');
            rxn.target = complementSeq(rxn.target, true); //just gives the compliment, not reversed
            b2match = alignPrimer(rxn.target, rxn.b2);
            f2match = alignPrimer(rxn.target, rxn.f2);
        } else {
            console.warn('just need to reverse the input strand');
            rxn.target = rxn.target.split('').reverse().join('');
            b2match = alignPrimer(rxn.target, rxn.b2);
            f2match = alignPrimer(rxn.target, rxn.f2);
        }
    }

    //after this all should be b2.....f2c

    var temp = rxn.target.substring(
        b2match.index + rxn.b2.length,
        f2match.index
    );

    if (temp.length < rxn.b1.length){
        throw new Error('error in the primer input. primers do not align to the target in the expected format. please check the provided sequences');
    }
    var b1match = alignPrimer(temp, rxn.b1);
    b1match.index += b2match.index + rxn.b2.length;
    temp = rxn.target.substring(b1match.index + rxn.b1.length, f2match.index);

    if (temp.length < rxn.b1.length){
        throw new Error('error in the primer input. primers do not align to the target in the expected format. please check the provided sequences');
    }
    var f1match = alignPrimer(temp, rxn.f1);
    f1match.index += b1match.index + rxn.b1.length;

    //all the indicies must be right due to our substring restriction. now check the directions
    //already know that b2 is not reversed and order is b2...b1....f1....f2
    if (!b1match.reverse){ //should be true, revcomp the primer
        rxn.b1 = complementSeq(rxn.b1, true);
        b1match.reverse = true;
    }
    if (f1match.reverse){ //should be false
        rxn.f1 = complementSeq(rxn.f1, true);
        f1match.reverse = true;
    }
    if (!f2match.reverse){ //should be true
        rxn.f2 = complementSeq(rxn.f2, true);
        f2match.reverse = true;
    }

    var matches = {b1: b1match, b2: b2match, f1: f1match, f2: f2match};
    return [rxn, matches];
};

/**
 * Create the building block sequences for the LAMP reaction
 * @param {LampReaction} reaction
 * @param {PrimerPosition} primerPositions
 *
 * @returns {LampBuildingBlocks} the building blocks for the amplification products
 */
const createAmplificationBlocks = (reaction, primerPositions) => {
    const bplus = `${reaction.b1}${reaction.linker}${reaction.b2}${
        reaction.target.substring(
            primerPositions.b2.index + reaction.b2.length,
            primerPositions.b1.index + reaction.b1.length
        )}`;
    const bminus = complementSeq(bplus, true);
    const fplus = `${
        reaction.target.substring(
            primerPositions.f1.index,
            primerPositions.f2.index - 1
        )}${reaction.f2}${reaction.linker}${reaction.f1}`;
    const fminus = complementSeq(fplus, true);
    const plus = reaction.target.substring(
        primerPositions.b1.index + reaction.b1.length,
        primerPositions.f1.index - 1
    );
    const minus = complementSeq(plus, true);
    return {bplus, bminus, fplus, fminus, plus, minus};
};

/**
 *
 * @param {LampBuildingBlocks} blocks
 */
const amplifyBlocks = ({bplus, bminus, plus, minus, fplus, fminus}) => {
    const products = [];
    let temp = `${bplus}${plus}${fplus}`; //6
    products.push(temp);
    temp += `${minus}${bminus}`; //7
    products.push(temp);
    temp += `${plus}${fminus}${minus}${bminus}`; //9
    products.push(temp);
    temp += `${plus}${fplus}${minus}${bplus}${plus}${fminus}${minus}${bminus}`; //13
    products.push(temp);
    temp += `${plus}${fplus}${minus}${bminus}${plus}${fminus}${minus}${bplus}${plus}${fplus}${minus}${bplus}${plus}${fminus}${minus}${bminus}`; //15
    products.push(temp);
    temp = `${fminus}${minus}${bplus}${plus}${fplus}${minus}${bplus}${plus}${fminus}${minus}${bminus}`; //17
    products.push(temp);
    temp = `${fminus}${minus}${bminus}`; //20
    products.push(temp);
    temp += `${plus}${fplus}`; //10
    products.push(temp);
    temp = `${bplus}${plus}${fminus}${minus}${bminus}`; //16
    products.push(temp);
    temp = `${bplus}${plus}${fplus}${minus}${bplus}${plus}${fminus}${minus}${bminus}`; // 18
    products.push(temp);
    temp += `${plus}${fplus}${minus}${bminus}${plus}${fminus}${minus}${bminus}`; //19
    products.push(temp);

    return products;
};


const enzymeCutSiteRegex = ({cutsite}) => {
    var temp = cutsite.toLowerCase();
    var reg = [];

    for (var i = 0; i < temp.length; i++){
        var str = '';

        switch (temp.charAt(i)){
            case 'a':
            case 't':
            case 'c':
            case 'g':
                str = temp.charAt(i);
                break;
            case 'm':
                str = '[ac]'; break;
            case 'k':
                str = '[gt]'; break;
            case 'r':
                str = '[ag]'; break;
            case 'y':
                str = '[ct]'; break;
            case 'w':
                str = '[at]'; break;
            case 's':
                str = '[gc]'; break;
            case 'h':
                str = '[act]'; break;
            case 'v':
                str = '[acg]'; break;
            case 'n':
                str = '[atcgmkrywshvnbd]'; break;
            case 'b':
                str = '[cgt]'; break;
            case 'd':
                str = '[agt]'; break;
            default:
                throw new Error(`error, unrecognized character ${temp.charAt(i)}`);
        }
        reg.push(str);
    }
    return new RegExp(reg.join(''), 'gi');
};


const cutProductsWithEnzyme = (products, enzyme) => {
    var re = enzymeCutSiteRegex(enzyme);
    var fragments = [];

    for (var i = 0; i < products.length; i++){
        var temp = products[i];
        var result;
        var indicies = [];

        while ((result = re.exec(temp)) !== null){
            var {index} = result;
            indicies.push(index);
        }
        var prev = 0;

        if (indicies.length == 0){
            fragments.push(products[i].length);
        }

        for (var j = 0; j < indicies.length; j++){
            var f = indicies[j] + enzyme.cutindex - prev;
            fragments.push(f);
            prev = indicies[j];
        }
    }

    if (fragments.length == 0){
        return null;
    }
    return fragments.sort();
};


const reverseCompEnzyme = (ren) => {
    var site = complementSeq(ren.cutsite, true);
    var halfway = Math.ceil(ren.cutsite.length / 2.0);

    if (site.localeCompare(ren.cutsite) && ren.cutindex == halfway){
        return null;
    }
    var result = {name: ren.name, cutindex: ren.cutsite.length - ren.cutindex, cutsite: site};
    return result;
};


/**
 *
 * @param {Array.<string>} products the LAMP product sequences
 * @param {Array.<string>} layout the lanes. A list of restriction enzyme names and ladder names
 */
const digestProducts = (products, layout) => {
    const undigestedProduct = products.map(p => p.length).sort();
    var lanes = [];

    for (const name of layout){

        if (!name) {
            lanes.push(undigestedProduct);
        } else if (name === '100bp') {
            // concat to make the ladder darker
            lanes.push(bpLadders['100'].concat(bpLadders['100']));
        } else if (name === '50bp') {
            // concat to make the ladder darker
            lanes.push(bpLadders['50'].concat(bpLadders['50']));
        } else if (enzymes[name] === undefined) {
            throw new Error(`Did not recognize restriction digest enzyme ${name}`);
        } else {
            const enzyme = enzymes[name];
            const reverseEnzyme = reverseCompEnzyme(enzyme);
            let fragments;

            if (!reverseEnzyme){
                fragments = cutProductsWithEnzyme(products, enzyme);
            } else {
                fragments = cutProductsWithEnzyme(products, enzyme);
                fragments.concat(cutProductsWithEnzyme(products, reverseEnzyme));
            }
            // if the enzyme didn't cute anything, return the undigested product
            if (fragments.length === 0){
                lanes.push(undigestedProduct);
            } else {
                lanes.push(fragments);
            }
        }
    }
    return lanes;
};


const createLampReaction = (fastaContent, lanesLayout = ['100bp', '50bp', '']) => {
    const [reaction, primerPositions] = getPrimerLayout(parseLampFasta(fastaContent));
    const blocks = createAmplificationBlocks(reaction, primerPositions);
    const products = amplifyBlocks(blocks);
    const lanes = digestProducts(products, lanesLayout);
    return {reaction, lanes, undigestedProduct: products.map(p => p.length).sort()};
};

try {
    module.exports = {
        parseLampFasta,
        createLampReaction,
        createAmplificationBlocks,
        amplifyBlocks,
        getPrimerLayout,
        complementSeq
    };
} catch (err) {}
